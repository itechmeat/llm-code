# Azure Provider Credentials Template
# Create Secret for Azure credentials used by CAPZ (Cluster API Provider Azure)
# IMPORTANT: Replace placeholder values before applying
---
apiVersion: v1
kind: Secret
metadata:
  name: capz-manager-bootstrap-credentials
  namespace: capz-system
type: Opaque
stringData:
  # Service Principal credentials (JSON format)
  # Create using: az ad sp create-for-rbac --sdk-auth
  clientSecret: |
    {
      "clientId": "<YOUR_CLIENT_ID>",
      "clientSecret": "<YOUR_CLIENT_SECRET>",
      "subscriptionId": "<YOUR_SUBSCRIPTION_ID>",
      "tenantId": "<YOUR_TENANT_ID>",
      "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",
      "resourceManagerEndpointUrl": "https://management.azure.com/",
      "activeDirectoryGraphResourceId": "https://graph.windows.net/",
      "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",
      "galleryEndpointUrl": "https://gallery.azure.com/",
      "managementEndpointUrl": "https://management.core.windows.net/"
    }

---
# Steps to create Azure Service Principal:
#
# 1. Login to Azure CLI:
#    az login
#
# 2. Set subscription:
#    az account set --subscription "<SUBSCRIPTION_ID>"
#
# 3. Create Service Principal with Contributor role:
#    az ad sp create-for-rbac \
#      --name "cluster-api-provider-azure" \
#      --role Contributor \
#      --scopes "/subscriptions/<SUBSCRIPTION_ID>" \
#      --sdk-auth > azure-credentials.json
#
# 4. The output JSON contains all required credentials
#
# Optional: For more restrictive permissions, use custom role:
#
# az role definition create --role-definition '{
#   "Name": "CAPZ Minimum Permissions",
#   "Description": "Minimum permissions for Cluster API Provider Azure",
#   "Actions": [
#     "Microsoft.Compute/*",
#     "Microsoft.Network/*",
#     "Microsoft.Resources/*",
#     "Microsoft.Authorization/*/read",
#     "Microsoft.ManagedIdentity/userAssignedIdentities/*"
#   ],
#   "NotActions": [],
#   "AssignableScopes": ["/subscriptions/<SUBSCRIPTION_ID>"]
# }'

---
# Environment variables for clusterctl (place in ~/.bashrc or export before init)
#
# # Azure subscription
# export AZURE_SUBSCRIPTION_ID="<YOUR_SUBSCRIPTION_ID>"
# export AZURE_TENANT_ID="<YOUR_TENANT_ID>"
# export AZURE_CLIENT_ID="<YOUR_CLIENT_ID>"
# export AZURE_CLIENT_SECRET="<YOUR_CLIENT_SECRET>"
#
# # Cluster settings
# export AZURE_LOCATION="eastus"
# export AZURE_RESOURCE_GROUP="my-cluster-rg"
#
# # Control plane settings
# export AZURE_CONTROL_PLANE_MACHINE_TYPE="Standard_D2s_v3"
# export CONTROL_PLANE_MACHINE_COUNT=3
#
# # Worker settings
# export AZURE_NODE_MACHINE_TYPE="Standard_D4s_v3"
# export WORKER_MACHINE_COUNT=3
#
# # SSH key
# export AZURE_SSH_PUBLIC_KEY_B64=$(cat ~/.ssh/id_rsa.pub | base64 | tr -d '\n')

---
# Initialize Azure provider:
#
# # Generate base64 encoded credentials
# export AZURE_SUBSCRIPTION_ID_B64=$(echo -n "$AZURE_SUBSCRIPTION_ID" | base64)
# export AZURE_TENANT_ID_B64=$(echo -n "$AZURE_TENANT_ID" | base64)
# export AZURE_CLIENT_ID_B64=$(echo -n "$AZURE_CLIENT_ID" | base64)
# export AZURE_CLIENT_SECRET_B64=$(echo -n "$AZURE_CLIENT_SECRET" | base64)
#
# clusterctl init --infrastructure azure

---
# Azure identity types available:
#
# 1. AzureClusterIdentity with Service Principal
# 2. AzureClusterIdentity with User-Assigned Managed Identity
# 3. AzureClusterIdentity with System-Assigned Managed Identity (AKS)
#
# Example Service Principal identity:
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AzureClusterIdentity
metadata:
  name: cluster-identity
  namespace: default
spec:
  type: ServicePrincipal
  allowedNamespaces:
    list:
      - default
  tenantID: "<YOUR_TENANT_ID>"
  clientID: "<YOUR_CLIENT_ID>"
  clientSecret:
    name: capz-manager-bootstrap-credentials
    namespace: capz-system

---
# Example User-Assigned Managed Identity:
#
# apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
# kind: AzureClusterIdentity
# metadata:
#   name: cluster-identity-msi
#   namespace: default
# spec:
#   type: UserAssignedMSI
#   allowedNamespaces:
#     list:
#       - default
#   tenantID: "<YOUR_TENANT_ID>"
#   clientID: "<MANAGED_IDENTITY_CLIENT_ID>"
#   resourceID: "/subscriptions/<SUB_ID>/resourceGroups/<RG>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/<IDENTITY_NAME>"
